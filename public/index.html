<head>
    <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="leaflet/leaflet.css"/>
    <script src="leaflet/leaflet.js"></script>
    <script src="entries.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="logo.png">
            <h1>Impact.surf</h1>
        </div>
      
        <div class="controls">
            <div class="stack">
                <h3 class="lbl">Search Radius</h2>
                <input type="range" id="radiusSlider" min="500" max="5000" step="50" value="1000"/>
                <h3 class="lbl" id="radius">1 km</h2>
            </div>
            <div class="stack">
                <h3 class="lbl">Max Count</h2>
                <input type="range" id="maxCount" min="1" max="200" step="1" value="50"/>
                <h3 class="lbl" id="max">50 results</h2>
            </div>
            <button id="search">Search</button>
        </div>
      </header>
    <div id="map"></div>
</body>
<script>
    toronto = [43.65501209297436, -79.38350421469008]
    const map = L.map("map").setView(toronto, 15)

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map)

    let init = true

    const markerIcon = L.icon({iconUrl: "marker.png", iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -35]})
    let marker
    let circle
    let latlng
    let radius = 1000
    let max = 50

    map.on("click", (e) => {
        if (!init) {
            return
        }
        latlng = e.latlng

        if (marker) {
            marker.setLatLng(e.latlng)
            circle.setLatLng(e.latlng)
        } else {
            marker = L.marker(e.latlng, {icon: markerIcon}).addTo(map)
            circle = L.circle(e.latlng, {
                radius: radius,
                color: "#007BFF",
                fillColor: "#007BFF",
                fillOpacity: 0.2
            }).addTo(map)
        }
    })

    document.getElementById("radiusSlider").addEventListener("input", function(e) {
        radius = parseInt(e.target.value)
        document.getElementById("radius").innerHTML = `${radius / 1000} km`
        if (init && circle) {
            circle.setRadius(radius)
        }
    })

    document.getElementById("maxCount").addEventListener("input", function(e) {
        max = parseInt(e.target.value)
        document.getElementById("max").innerHTML = `${max} results`
    })

    function randOffset(lat, lng) {
        return L.latLng(lat + Math.random() / 100, lng + Math.random() / 100)
    }

    for (const entry of entries) {
        entry["pos"] = randOffset(parseFloat(entry.lat), parseFloat(entry.lon))
    }

    function generatePopup(entry) {
        return `<h1>${entry["Account Name"]}</h1>
<h3>${entry["Address Line 1"]}</h3>
<img src="https://${entry["url"]}/favicon.ico" height="250" width="250">
<h3>Ai Overview</h3>
<p id="${entry["BN"]}">Working...</p>
<a target="_blank" href="https://${entry["url"]}">${entry["url"].toLowerCase()}</a>`
    }

    function generateMarker(entry) {
        const marker = L.marker(entry["pos"], {icon: markerIcon}).addTo(map)
        marker.bindPopup(generatePopup(entry))
        marker.on("click", async (e) => {
            setTimeout(() => {
                fetch("https://impact.surf/relay", {method: "GET", headers: {"url": entry["url"], "address": entry["Address Line 1"], "name": entry["Legal Name"]}}).then(res => res.text()).then(text => {
                    document.getElementById(entry["BN"]).innerHTML = text
                })
            })
        })
    }

    document.getElementById("search").addEventListener("click", () => {
        if (init && latlng) {
            init = false
            const pool = []
            for (const entry of entries) {
                if (latlng.distanceTo(entry["pos"]) < radius) {
                    pool.push(entry)
                }
            }
            if (pool.length > 200) {
                for (let i = pool.length - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1))
                    const t = pool[j]
                    pool[i] = pool[j]
                    pool[j] = t
                }
                for (let i = 0; i < max; i++) {
                    generateMarker(pool[i])
                }
            } else {
                for (const entry of pool) {
                    generateMarker(entry)
                }
            }
        }
    })
</script>